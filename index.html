<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Full-Screen Strudel.js REPL</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #0a0a0a;
        color: #f0f0f0;
        height: 100vh;
        overflow: hidden;
      }

      #container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #0f3460;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo i {
        color: #00ffaa;
        font-size: 1.8rem;
        filter: drop-shadow(0 0 5px rgba(0, 255, 170, 0.5));
      }

      .logo h1 {
        font-size: 1.6rem;
        font-weight: 700;
        background: linear-gradient(90deg, #00ffaa, #0099ff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .logo .version {
        font-size: 0.8rem;
        color: #88aadd;
        margin-left: 5px;
      }

      .controls {
        display: flex;
        gap: 12px;
      }

      .btn {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        font-weight: 600;
        backdrop-filter: blur(10px);
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .btn-primary {
        background: linear-gradient(135deg, #00b4db, #0083b0);
        border: none;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #00c6ff, #0099cc);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        border: none;
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, #ff4b7a, #ff5533);
      }

      #strudel-frame-container {
        flex: 1;
        position: relative;
        background-color: #000;
        overflow: hidden;
      }

      #strudel-frame {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 50;
        transition: opacity 0.5s;
      }

      .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(0, 255, 170, 0.2);
        border-top: 5px solid #00ffaa;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 25px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 1.2rem;
        color: #00ffaa;
        margin-bottom: 15px;
        text-align: center;
      }

      .loading-subtext {
        color: #88aadd;
        text-align: center;
        max-width: 500px;
        line-height: 1.5;
        margin-bottom: 25px;
      }

      .pattern-presets {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 20px;
      }

      .preset-btn {
        background: rgba(0, 100, 255, 0.2);
        color: #88ccff;
        border: 1px solid rgba(100, 200, 255, 0.3);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
      }

      .preset-btn:hover {
        background: rgba(0, 150, 255, 0.3);
        transform: translateY(-2px);
      }

      footer {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 12px 25px;
        text-align: center;
        border-top: 2px solid #0f3460;
        font-size: 0.9rem;
        color: #88aadd;
        flex-shrink: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      footer a {
        color: #00ffaa;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s;
      }

      footer a:hover {
        color: #ffffff;
        text-decoration: underline;
      }

      .footer-right {
        display: flex;
        gap: 20px;
      }

      .footer-link {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      .modal.active {
        opacity: 1;
        pointer-events: all;
      }

      .modal-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 30px;
        border-radius: 15px;
        border: 2px solid #00ffaa;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h2 {
        color: #00ffaa;
        font-size: 1.5rem;
      }

      .close-modal {
        background: none;
        border: none;
        color: #ff6b6b;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px;
      }

      .modal-body {
        line-height: 1.6;
        color: #ccc;
      }

      .modal-body h3 {
        color: #00ffaa;
        margin: 15px 0 10px;
      }

      .modal-body code {
        background: rgba(0, 0, 0, 0.3);
        padding: 3px 6px;
        border-radius: 4px;
        font-family: monospace;
        color: #88ddff;
      }

      .modal-body ul {
        margin: 10px 0 10px 20px;
      }

      .modal-body li {
        margin-bottom: 8px;
      }

      @media (max-width: 768px) {
        header {
          flex-direction: column;
          gap: 15px;
          padding: 15px;
        }

        footer {
          flex-direction: column;
          gap: 10px;
          text-align: center;
        }

        .footer-right {
          flex-wrap: wrap;
          justify-content: center;
        }

        .btn {
          padding: 8px 12px;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="container">
      <header>
        <div class="logo">
          <i class="fas fa-wave-square"></i>
          <h1>Strudel.js REPL<span class="version">Live Editor</span></h1>
        </div>
        <div class="controls">
          <button class="btn btn-primary" id="fullscreen-btn">
            <i class="fas fa-expand"></i> Fullscreen
          </button>
          <button class="btn" id="instructions-btn">
            <i class="fas fa-question-circle"></i> Instructions
          </button>
          <button class="btn" id="reload-btn">
            <i class="fas fa-redo"></i> Reload
          </button>
        </div>
      </header>

      <div id="strudel-frame-container">
        <div class="loading-overlay" id="loading-overlay">
          <div class="spinner"></div>
          <div class="loading-text">Loading Strudel.js REPL</div>
          <div class="loading-subtext">
            This embeds the official Strudel REPL from
            strudel.tidalcycles.org.<br />
            The environment is fully functional with live coding capabilities.
          </div>
          <div class="pattern-presets">
            <button class="preset-btn" data-preset="drums">
              Load Drum Example
            </button>
            <button class="preset-btn" data-preset="melody">
              Load Melody Example
            </button>
            <button class="preset-btn" data-preset="ambient">
              Load Ambient Example
            </button>
          </div>
        </div>

        <iframe
          id="strudel-frame"
          src="https://strudel.tidalcycles.org/"
          allow="microphone; midi"
          sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-modals"
          title="Strudel.js REPL"
        >
        </iframe>
      </div>

      <footer>
        <div class="footer-left">
          <p>
            Powered by
            <a href="https://strudel.tidalcycles.org/" target="_blank"
              >Strudel.js</a
            >
            | Live coding music environment in the browser
          </p>
        </div>
        <div class="footer-right">
          <div class="footer-link">
            <i class="fas fa-book"></i>
            <a href="https://tidalcycles.org/" target="_blank"
              >TidalCycles Docs</a
            >
          </div>
          <div class="footer-link">
            <i class="fab fa-github"></i>
            <a href="https://github.com/tidalcycles/strudel" target="_blank"
              >GitHub</a
            >
          </div>
          <div class="footer-link">
            <i class="fas fa-volume-up"></i>
            <a href="#" id="audio-toggle">Enable Audio</a>
          </div>
        </div>
      </footer>

      <div class="modal" id="instructions-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Strudel.js Instructions</h2>
            <button class="close-modal" id="close-modal">&times;</button>
          </div>
          <div class="modal-body">
            <h3>Getting Started</h3>
            <p>
              This page embeds the official Strudel.js REPL from
              strudel.tidalcycles.org. It's a fully functional live coding
              environment for creating music in the browser.
            </p>

            <h3>Basic Usage</h3>
            <ul>
              <li>Type patterns in the code editor on the left</li>
              <li>Press <code>Shift+Enter</code> to evaluate a pattern</li>
              <li>Press <code>Escape</code> to stop all sound</li>
              <li>Use the buttons above the editor for common operations</li>
            </ul>

            <h3>Quick Examples</h3>
            <p><strong>Drums:</strong> <code>s("bd sd hh cp")</code></p>
            <p>
              <strong>Melody:</strong>
              <code>note("0 2 4 7").scale("major")</code>
            </p>
            <p>
              <strong>Combined:</strong>
              <code>s("bd sd").note("0 4").scale("minor")</code>
            </p>

            <h3>Tips</h3>
            <ul>
              <li>
                Click "Enable Audio" in the footer if you don't hear sound
              </li>
              <li>Use <code>.slow(2)</code> to slow down patterns</li>
              <li>Use <code>.fast(2)</code> to speed up patterns</li>
              <li>Square brackets <code>[]</code> create polyrhythms</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Get DOM elements
        const strudelFrame = document.getElementById("strudel-frame");
        const loadingOverlay = document.getElementById("loading-overlay");
        const fullscreenBtn = document.getElementById("fullscreen-btn");
        const reloadBtn = document.getElementById("reload-btn");
        const instructionsBtn = document.getElementById("instructions-btn");
        const closeModalBtn = document.getElementById("close-modal");
        const instructionsModal = document.getElementById("instructions-modal");
        const audioToggle = document.getElementById("audio-toggle");
        const presetButtons = document.querySelectorAll(".preset-btn");

        // Hide loading overlay when iframe loads
        strudelFrame.addEventListener("load", function () {
          setTimeout(() => {
            loadingOverlay.classList.add("hidden");

            // Inject code to ensure audio is enabled
            try {
              const iframeDoc =
                strudelFrame.contentDocument ||
                strudelFrame.contentWindow.document;
              if (iframeDoc) {
                console.log("Strudel REPL loaded successfully");
              }
            } catch (e) {
              console.log(
                "Strudel REPL loaded (cross-origin restrictions apply)"
              );
            }
          }, 1500);
        });

        // Toggle fullscreen
        function toggleFullscreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch((err) => {
              console.error(
                `Error attempting to enable fullscreen: ${err.message}`
              );
            });
            fullscreenBtn.innerHTML =
              '<i class="fas fa-compress"></i> Exit Fullscreen';
          } else {
            if (document.exitFullscreen) {
              document.exitFullscreen();
              fullscreenBtn.innerHTML =
                '<i class="fas fa-expand"></i> Fullscreen';
            }
          }
        }

        // Reload the iframe
        function reloadIframe() {
          loadingOverlay.classList.remove("hidden");
          strudelFrame.src = strudelFrame.src; // Reload by resetting src
        }

        // Show instructions modal
        function showInstructions() {
          instructionsModal.classList.add("active");
        }

        // Hide instructions modal
        function hideInstructions() {
          instructionsModal.classList.remove("active");
        }

        // Toggle audio context (for embedded iframe)
        function toggleAudio() {
          // This is a workaround to ensure audio starts
          // by simulating a click inside the iframe
          try {
            const iframeWindow = strudelFrame.contentWindow;

            // Post a message to the iframe to trigger audio context
            iframeWindow.postMessage("startAudio", "*");

            // Also try to focus and click
            strudelFrame.focus();

            // Update button text
            audioToggle.textContent = "Audio Enabled";
            audioToggle.style.color = "#00ffaa";

            console.log("Audio context activation attempted");
          } catch (e) {
            console.log("Could not communicate with iframe due to CORS");

            // Fallback: just reload
            reloadIframe();
          }
        }

        // Load preset pattern
        function loadPreset(presetType) {
          // These are example patterns that will be shown in the instructions
          // In a real implementation, we'd inject them into the iframe
          const presets = {
            drums: 's("bd sd [hh cp] ho")',
            melody: 'note("0 [3 5] 7 [2 4]").scale("minor").sound("sawtooth")',
            ambient:
              'note("<0 5> <7 12>").scale("major").sound("sine").room(0.9).size(0.9).slow(8)',
          };

          // Show instructions with the preset
          showInstructions();

          // Update instructions to show the preset
          const modalBody = document.querySelector(".modal-body");
          const presetHTML = `
                    <h3>Preset Loaded: ${presetType}</h3>
                    <p>Copy this code into the Strudel editor:</p>
                    <code style="display: block; background: #000; padding: 10px; margin: 10px 0; border-radius: 5px;">${presets[presetType]}</p>
                    <p>Press <code>Shift+Enter</code> to run it.</p>
                `;

          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = presetHTML;

          // Insert after the first h3
          const firstH3 = modalBody.querySelector("h3");
          if (firstH3) {
            firstH3.parentNode.insertBefore(
              tempDiv.firstChild,
              firstH3.nextSibling
            );
          }
        }

        // Event listeners
        fullscreenBtn.addEventListener("click", toggleFullscreen);
        reloadBtn.addEventListener("click", reloadIframe);
        instructionsBtn.addEventListener("click", showInstructions);
        closeModalBtn.addEventListener("click", hideInstructions);
        audioToggle.addEventListener("click", function (e) {
          e.preventDefault();
          toggleAudio();
        });

        presetButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            loadPreset(this.dataset.preset);
          });
        });

        // Close modal when clicking outside
        instructionsModal.addEventListener("click", function (e) {
          if (e.target === instructionsModal) {
            hideInstructions();
          }
        });

        // Handle fullscreen change
        document.addEventListener("fullscreenchange", function () {
          if (!document.fullscreenElement) {
            fullscreenBtn.innerHTML =
              '<i class="fas fa-expand"></i> Fullscreen';
          }
        });

        // Listen for messages from the iframe (for future enhancements)
        window.addEventListener("message", function (event) {
          // You could add communication with the iframe here
          console.log("Message from iframe:", event.data);
        });

        // Auto-hide loading overlay after timeout (fallback)
        setTimeout(() => {
          loadingOverlay.classList.add("hidden");
        }, 5000);

        console.log("Strudel.js REPL embed initialized");
      });
    </script>
  </body>
</html>
